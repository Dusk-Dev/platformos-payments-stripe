{%log data, type: "webhook sub deleted data"%}

{% comment %}
  Update current subscription data
{% endcomment %}

{%liquid
  graphql su = 'modules/payments/get_subscription_by_gateway_id', gateway_id: data.id
  assign currentSub = su.customizations.results.first

  if currentSub == blank
    function result = "api/orders/error_response", error: "You are not subscribed to any plan."
    return result
  endif
%}

{% assign default_mpo = context.constants.mpo_fee_percent | divided_by: 1.0 %}

{% graphql g, id: data.external_id %}
  mutation update_fee(
    $id: ID!
  ) {
    user_update(
      id: $id
      user: {
        properties: [
          { name: "mpo_fee_percent", value_float: {{ default_mpo }} }
          { name: "is_premium", value_boolean: false }
        ]
      }
    ) {
      id
    }
  }
{% endgraphql %}

{% graphql update = 'modules/payments/update_subscription',
  id: currentSub.id,
  cancel_at_period_end: data.cancel_at_period_end,
  cancel_at: data.cancel_at,
  canceled_at: data.canceled_at
%}
{%log update%}



{%- parse_json 'response_body' -%}
  {{ gateway_response.body }}
{%- endparse_json -%}

{%- if gateway_response.status == 200 -%}

  {%- assign now = 'now' | to_time | strftime: "%d-%m-%Y %H:%M:%S"  -%}
  {% if response_body.status == "pending" %}
    {% assign status = "pending" %}
  {% elsif response_body.status != 'succeeded' %}
    {% assign status = "failed" %}
  {% elsif response_body.captured %}
    {% assign status = "paid" %}
  {% else %}
    {% assign status = "authorized" %}
  {% endif %}
  {
    {%- if response_body.error -%}
      "errors": [
        {"message": "{{ response_body.error.message }}"}
      ],
    {%- endif -%}
    "properties": [
      { "name": "credit_card_id", "value": "{{ data.credit_card_id }}" },
      { "name": "customer_id", "value": "{{ data.customer_id }}" },
      { "name": "external_id", "value": "{{ data.external_id }}" },
      { "name": "gateway_id", "value": "{{ response_body.id }}" },
      { "name": "amount_cents", "value": "{{ response_body.amount }}" },
      { "name": "currency", "value": "{{ response_body.currency }}" },
      { "name": "description", "value": "{{ response_body.description }}" },
      { "name": "statement_descriptor", "value": "{{ response_body.statement_descriptor }}" },
      { "name": "statement_descriptor_suffix", "value": "{{ response_body.statement_descriptor_suffix }}" },
      { "name": "application_fee_cents", "value": "{{ response_body.application_fee_amount }}" },
      { "name": "destination", "value": "{{ response_body.destination }}" },
      { "name": "transfer_group", "value": "{{ response_body.transfer_group }}" },
      { "name": "paid_at", "value": "{% if status == "paid" %}{{ now }}{% endif %}" },
      { "name": "state", "value": "{{ status }}" }
    ]
  }
{%- else -%}
  {
    "errors": {{ response_body.error.message | json }}
  }
{%- endif -%}

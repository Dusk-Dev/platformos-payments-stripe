{% assign data = params.properties_attributes.data %}
{% comment %}{% log params, type: "DEBUG Callback params" %}{% endcomment %}
{% for person_hash in data.persons %}
  {% assign person = person_hash.last %}
  {% assign token = person.token %}
  {% if token or person.gateway_id %}
    {%- assign gateway_api_template = "modules/stripe/create_person" -%}

    {% parse_json 'person_data' %}
      {
        "gateway_id": "{{ person.gateway_id }}",
        "account_id": "{{ customization.properties.gateway_id }}",
        "person_token": "{{ token }}",
        "indempotency_key": "{{ indempotency_key }}"

      }
    {% endparse_json %}

    {% comment %}{% log person_data, type: "PERSON DATA" %}{% endcomment %}

    {%- graphql person_response = 'modules/payments/gateway_request', data: person_data, api_template: gateway_api_template -%}
    {% comment %}{% log person_response, type: "Person Response" %}{% endcomment %}
  {% endif %}
{% endfor %}

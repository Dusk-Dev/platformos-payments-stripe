{% log "parsing response "%}
{%- parse_json 'response_body' -%}
  {{ gateway_response.body }}
{%- endparse_json -%}
{% log "end parsing response "%}

{%- if gateway_response.status == 200 -%}
  {%- assign account_state = 'pending' -%}
  {%- if response_body.payouts_enabled == true and response_body.charges_enabled == true -%}
    {%- assign account_state = 'verified' -%}
  {%- endif -%}

  {
    "id": "{{ data.id }}",
    "properties": [
      { "name": "external_id", "value": "{{ data.external_id }}" },
      { "name": "gateway_id", "value": "{{ response_body.id }}" },
      { "name": "state", "value": "{{ account_state }}" },
      { "name": "data", "value": "{{ response_body | json | replace: '"', '\"' }}" },
      { "name": "last_error", "value": "{{ response_body.error | json | replace: '"', '\"' }}"},
      { "name": "last_errors", "value": "{{ response_body.errors | json | replace: '"', '\"'  }}"},
      { "name": "queued", "value": "false" }
    ]
  }
{%- elsif data.id != blank  -%}
  {
    "id": "{{ data.id }}",
    "properties": [
      { "name": "last_error", "value": "{{ response_body.error | json | replace: '"', '\"'  }}"},
      { "name": "last_errors", "value": "{{ response_body.errors | json | replace: '"', '\"' }}"},
      { "name": "queued", "value": "false" }
    ]
  }
{% else %}
  {
    "errors": {{ response_body.error.message | json  }}
  }
{%- endif -%}
